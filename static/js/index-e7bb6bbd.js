import{i as N,e as Y,r as Z,f as q}from"./index-c3533fa0.js";import{u as H}from"./hook-37ea9ef9.js";import{v as ee,w as te}from"./@vue.runtime-dom-99571815.js";import{T as ne,U as oe,E as re}from"./@element-plus.icons-vue-73c86597.js";import{u as j}from"./index-292cfcf2.js";import{b as S,a as C}from"./element-plus-ca11a4ea.js";import{w as le}from"./lodash-es-74a5df03.js";import{j as D,d as se,X as p,$ as Q,o as I,c as U,a as x,b as n,K as i,N as X,L,O,J as A,n as ae,as as pe,ar as ie}from"./@vue.runtime-core-561bebe5.js";import{r as R,u as h}from"./@vue.reactivity-97074417.js";import{o as ce,O as de}from"./@vue.shared-40d3234d.js";import{_ as ue}from"./_plugin-vue_export-helper-c27b6911.js";import"./store-acb3382e.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-d82d1bdc.js";import"./vue-demi-71ba0ef2.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-0ed26588.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-c769f697.js";import"./@vueuse.core-c33523a6.js";import"./@vueuse.shared-b7ebfaaa.js";import"./mitt-b509fb6d.js";import"./mockjs-597bdf6e.js";import"./vue-052dfabe.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./dayjs-e0a79e34.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";const me=g=>(pe("data-v-cdd4b00d"),g=g(),ie(),g),_e={class:"dept-tree"},fe={class:"dept-tree__header"},be=me(()=>x("div",null,"組織架構",-1)),he={class:"dept-tree__op"},ve={class:"no"},ye=["onContextmenu"],we={class:"dept-tree__node"},ge=["onClick"],ke=["onClick"],xe=D({name:"dept-list"}),Ce=D({...xe,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(g,{emit:v}){const B=g,{service:m,browser:$}=j(),{ViewGroup:_}=H(),y=N.useForm(),d=R([]),f=R(!1),b=R(!1);function M({data:t}){return t.parentId}function l(t,e){return e.data.parentId}async function o(){f.value=!0,b.value=!1,await m.base.sys.department.list().then(t=>{var e;d.value=Y(t),(e=_.value)!=null&&e.selected||c()}),f.value=!1}function c(t){var e;if(t||(t=d.value[0]),t){const s=t.children?Z(t.children).map(r=>r.id):[];s.unshift(t.id),(e=_.value)==null||e.select(t),ae(()=>{v("refresh",{page:1,departmentIds:s})})}}function w(t){var s;const e=t.id?"update":"add";(s=y.value)==null||s.open({title:"編輯部門",width:"550px",props:{labelWidth:"100px"},items:[{label:"部門名稱",prop:"name",component:{name:"el-input"},required:!0},{label:"上級部門",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(r,{done:a,close:u}){m.base.sys.department[e]({id:t.id,parentId:t.parentId,name:r.name,orderNum:r.orderNum}).then(()=>{C.success(`新增部門 “${r.name}” 成功`),u(),o()}).catch(E=>{C.error(E.message),a()})}}},[N.setFocus()])}function G(t){async function e(s){await m.base.sys.department.delete({ids:[t.id],deleteUser:s}).then(()=>{var r,a;((a=(r=_.value)==null?void 0:r.selected)==null?void 0:a.id)==t.id&&c(),s?C.success("刪除成功"):S.confirm(`“${t.name}” 部門的用戶已成功轉移到 “${t.parentName}” 部門。`,"刪除成功")}),o()}S.confirm(`此操作將會刪除 “${t.name}” 部門的所有用戶，是否確認？`,"提示",{type:"warning",confirmButtonText:"直接刪除",cancelButtonText:"保留用戶",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(s=>{s=="cancel"&&e(!1)})}function V(t){t?S.confirm("部門架構已發生改變，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function s(r,a){r.forEach(u=>{u.parentId=a,e.push(u),u.children&&le(u.children)&&s(u.children,u.id)})}s(d.value,null),await m.base.sys.department.order(e.map((r,a)=>({id:r.id,parentId:r.parentId,orderNum:a}))).then(()=>{C.success("更新排序成功")}).catch(r=>{C.error(r.message)}),o(),b.value=!1}).catch(()=>null):o()}function T(t,e,s){e||(e=d.value[0]||{});const r=m.base.sys.department.permission;N.ContextMenu.open(t,{list:[{label:"新增",hidden:s&&s.level>=B.level||!q(r.add),callback(a){w({name:"",parentName:e.name,parentId:e.id}),a()}},{label:"編輯",hidden:!q(r.update),callback(a){w(e),a()}},{label:"刪除",hidden:!e.parentId||!q(r.delete),callback(a){G(e),a()}},{label:"新增成員",hidden:!q(r.add),callback(a){v("user-add",e),a()}}]})}return se(function(){o()}),(t,e)=>{const s=p("el-icon"),r=p("el-tooltip"),a=p("el-button"),u=p("el-tree"),E=p("el-scrollbar"),F=p("cl-form"),W=Q("loading");return I(),U("div",_e,[x("div",fe,[be,x("ul",he,[x("li",{onClick:e[0]||(e[0]=k=>o())},[n(r,{content:"刷新"},{default:i(()=>[n(s,null,{default:i(()=>[n(h(ne))]),_:1})]),_:1})]),g.drag&&!h($).isMini?(I(),U("li",{key:0,onClick:e[1]||(e[1]=k=>b.value=!0)},[n(r,{content:"拖動排序"},{default:i(()=>[n(s,null,{default:i(()=>[n(h(oe))]),_:1})]),_:1})])):X("",!0),L(x("li",ve,[n(a,{onClick:e[2]||(e[2]=k=>V(!0)),size:"small"},{default:i(()=>[O("保存")]),_:1}),n(a,{onClick:e[3]||(e[3]=k=>V(!1)),size:"small"},{default:i(()=>[O("取消")]),_:1})],512),[[ee,b.value]])])]),x("div",{class:"dept-tree__container",onContextmenu:te(T,["stop","prevent"])},[n(E,null,{default:i(()=>[L((I(),A(u,{"node-key":"id","default-expand-all":"",data:d.value,props:{label:"name"},draggable:b.value,"allow-drag":M,"allow-drop":l,"expand-on-click-node":!1,onNodeContextmenu:T},{default:i(({node:k,data:z})=>{var J,K;return[x("div",we,[x("span",{class:ce(["dept-tree__node-label",{"is-active":z.id==((K=(J=h(_))==null?void 0:J.selected)==null?void 0:K.id)}]),onClick:P=>c(z)},de(k.label),11,ge),h($).isMini?(I(),U("span",{key:0,class:"dept-tree__node-icon",onClick:P=>T(P,z,k)},[n(s,null,{default:i(()=>[n(h(re))]),_:1})],8,ke)):X("",!0)])]}),_:1},8,["data","draggable"])),[[W,f.value]])]),_:1})],40,ye),n(F,{ref_key:"Form",ref:y},null,512)])}}});const Ie=ue(Ce,[["__scopeId","data-v-cdd4b00d"]]),Ne={class:"dept-move"},$e=D({name:"user-move"}),Me=D({...$e,setup(g,{expose:v}){const{service:B}=j(),m=N.useForm(),$=N.useCrud();async function _(y){var d;(d=m.value)==null||d.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(f,{done:b,close:M}){if(!f.departmentId)return C.warning("请选择部门"),b();S.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{B.base.sys.user.move({...f,userIds:y}).then(()=>{var l;C.success("转移成功"),(l=$.value)==null||l.refresh(),M()}).catch(l=>{C.error(l.message),b()})}).catch(()=>null)}}})}return v({open:_}),(y,d)=>{const f=p("cl-form");return I(),U("div",Ne,[n(f,{ref_key:"Form",ref:m},null,512)])}}}),Te=D({name:"sys-user"}),ft=D({...Te,setup(g){const{service:v,refs:B,setRefs:m}=j(),{ViewGroup:$}=H({title:"用戶列表"}),_=N.useCrud({service:v.base.sys.user}),y=N.useTable({columns:[{type:"selection",width:60},{prop:"headImg",label:"頭像",component:{name:"cl-avatar"}},{prop:"username",label:"用戶名",minWidth:150},{prop:"name",label:"姓名",minWidth:150},{prop:"nickName",label:"暱稱",minWidth:150},{prop:"departmentName",label:"部門名稱",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:150,dict:[],formatter(l){var o;return(o=l.roleName)==null?void 0:o.split(",")}},{prop:"status",label:"狀態",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手機號碼",minWidth:150},{prop:"remark",label:"備註",minWidth:150},{prop:"createTime",label:"創建時間",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),d=N.useUpsert({dialog:{width:"800px"},items:[{prop:"headImg",label:"頭像",component:{name:"cl-upload",props:{text:"選擇頭像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"暱稱",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用戶名",required:!0,span:12,component:{name:"el-input"}},()=>{var l;return{prop:"password",label:"密碼",span:12,required:((l=d.value)==null?void 0:l.mode)=="add",component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密碼長度在 6 到 16 個字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手機號碼",span:12,component:{name:"el-input"}},{prop:"email",label:"郵箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"備註",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"狀態",value:1,component:{name:"el-radio-group",options:[{label:"開啟",value:1},{label:"關閉",value:0}]}}],onSubmit(l,{next:o}){var c,w;o({departmentId:(w=(c=$.value)==null?void 0:c.selected)==null?void 0:w.id,...l})},async onOpen(){v.base.sys.role.list().then(l=>{var o;(o=d.value)==null||o.setOptions("roleIdList",l.map(c=>({label:c.name||"",value:c.id})))})}});function f(l){var o;(o=_.value)==null||o.refresh(l)}function b({id:l}){var o;(o=_.value)==null||o.rowAppend({departmentId:l})}async function M(l){var c;let o=[];l?o=[l.id]:o=((c=y.value)==null?void 0:c.selection.map(w=>w.id))||[],B.userMove.open(o)}return(l,o)=>{const c=p("cl-refresh-btn"),w=p("cl-add-btn"),G=p("cl-multi-delete-btn"),V=p("el-button"),T=p("cl-flex1"),t=p("cl-search-key"),e=p("cl-row"),s=p("cl-table"),r=p("cl-pagination"),a=p("cl-upsert"),u=p("cl-crud"),E=p("cl-view-group"),F=Q("permission");return I(),A(E,{ref_key:"ViewGroup",ref:$},{left:i(()=>[n(Ie,{onRefresh:f,onUserAdd:b})]),right:i(()=>[n(u,{ref_key:"Crud",ref:_},{default:i(()=>[n(e,null,{default:i(()=>{var W;return[n(c),n(w),n(G),L((I(),A(V,{type:"success",disabled:((W=h(y))==null?void 0:W.selection.length)==0,onClick:o[0]||(o[0]=k=>M())},{default:i(()=>[O("轉移")]),_:1},8,["disabled"])),[[F,h(v).base.sys.user.permission.move]]),n(T),n(t,{placeholder:"搜索用戶名、姓名"})]}),_:1}),n(e,null,{default:i(()=>[n(s,{ref_key:"Table",ref:y},{"slot-btn":i(({scope:W})=>[L((I(),A(V,{text:"",bg:"",onClick:k=>M(W.row)},{default:i(()=>[O("轉移")]),_:2},1032,["onClick"])),[[F,h(v).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(e,null,{default:i(()=>[n(T),n(r)]),_:1}),n(a,{ref_key:"Upsert",ref:d},null,512),n(Me,{ref:h(m)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{ft as default};
