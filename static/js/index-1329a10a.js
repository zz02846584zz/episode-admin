import{d as oe}from"./dayjs-e0a79e34.js";import{j as L,u as A,i as K,a as W,m as ne}from"./index-c3533fa0.js";import"./store-acb3382e.js";import{u as X}from"./index-292cfcf2.js";import{J as ae,a2 as le,a3 as ce,a4 as ie,B as re,T as ue,a5 as _e,m as de}from"./@element-plus.icons-vue-73c86597.js";import{A as pe,j as z,t as R,X as u,$ as G,L as P,o as h,c as b,a as e,F as Y,b as t,N as F,K as d,V as Q,O as me,n as Z,J,E as ve}from"./@vue.runtime-core-561bebe5.js";import{d as ee}from"./pinia-d82d1bdc.js";import{r as $,u as o}from"./@vue.reactivity-97074417.js";import{a as fe}from"./@vueuse.core-c33523a6.js";import{a as he}from"./element-plus-ca11a4ea.js";import{O as I,o as O}from"./@vue.shared-40d3234d.js";import{_ as te}from"./_plugin-vue_export-helper-c27b6911.js";import{d as ge}from"./lodash-es-74a5df03.js";import"./chardet-cfd7d38a.js";import"./@vue.runtime-dom-99571815.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-0ed26588.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-c769f697.js";import"./mitt-b509fb6d.js";import"./mockjs-597bdf6e.js";import"./vue-052dfabe.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./vue-demi-71ba0ef2.js";import"./@vueuse.shared-b7ebfaaa.js";function se(){return{chat:pe("chat")}}const xe=ee("chat-message",()=>{const g=$(!1),m=$([]),x=$({page:1,total:0,size:20});async function _(p){g.value=!0,(p==null?void 0:p.page)==1&&(m.value=[]),await L.chat.message.page(p).then(y=>{m.value=y.list.map(n=>(n.content=JSON.parse(n.content),n)),x.value=y.pagination}),g.value=!1}return{loading:g,list:m,pagination:x,get:_}}),ye=ee("chat-session",()=>{const g=$(!1),m=$([]),x=$();async function _(y){g.value=!0,await L.chat.session.page(y).then(n=>{x.value||p(n.list[0]),m.value=n.list}),g.value=!1}function p(y){x.value=y}return{loading:g,list:m,value:x,get:_,set:p}});function H(){const g=ye(),m=xe();return{session:g,message:m}}const ke={class:"chat-message","element-loading-text":"消息列表加载中"},be={class:"head"},$e={class:"avatar"},Ce={class:"name"},we={class:"avatar"},Me=["onContextmenu"],Se={class:"h"},Te={class:"name"},Ve={class:"content"},Ne={key:0,class:"is-text"},Be={key:1,class:"is-image"},Ie={class:"footer"},ze={class:"tools"},De={class:"input"},Ue=z({name:"undefined"}),Ee=z({...Ue,setup(g){const{user:m}=A(),{chat:x}=se(),{message:_,session:p}=H(),{copy:y}=fe(),n=$(""),C=R(()=>{let f=0;return _.list.map(s=>{var k;return s.contentType==1&&(s._index=f++),s.isMy=s.fromId==((k=m.info)==null?void 0:k.id),s})}),S=R(()=>_.list.filter(f=>f.contentType==1).map(f=>{var s;return(s=f.content)==null?void 0:s.imageUrl}).filter(Boolean));function T(){x.send({contentType:0,content:{text:n.value}},!0),n.value=""}function v(f){x.send({contentType:1,content:{imageUrl:f.url}},!0),n.value=""}function a(f,s){K.ContextMenu.open(f,{hover:{target:"content"},list:[{label:"复制",callback(k){y(s.content.text||""),he.success("复制成功"),k()}},{label:"转发"},{label:"删除"}]})}return(f,s)=>{var c,i,M,N;const k=u("cl-avatar"),B=u("el-image"),D=u("el-scrollbar"),w=u("el-icon"),U=u("cl-upload"),V=u("el-input"),l=u("el-button"),E=G("loading");return P((h(),b("div",ke,[e("div",be,[(c=o(p))!=null&&c.value?(h(),b(Y,{key:0},[e("div",$e,[t(k,{size:30,shape:"square",src:(i=o(p))==null?void 0:i.value.avatar},null,8,["src"])]),e("span",Ce,"与“"+I((M=o(p))==null?void 0:M.value.nickName)+"”聊天中",1)],64)):F("",!0)]),t(D,{class:"list"},{default:d(()=>[e("ul",null,[(h(!0),b(Y,null,Q(C.value,(r,q)=>(h(),b("li",{key:q},[e("div",{class:O(["item",{"is-right":r.isMy}])},[e("div",we,[t(k,{size:36,shape:"square",src:r.avatar},null,8,["src"])]),e("div",{class:"det",onContextmenu:j=>{a(j,r)}},[e("div",Se,[e("span",Te,I(r.nickName),1)]),e("div",Ve,[r.contentType==0?(h(),b("div",Ne,[e("span",null,I(r.content.text),1)])):r.contentType==1?(h(),b("div",Be,[t(B,{src:r.content.imageUrl,"preview-src-list":S.value,"initial-index":r._index,"scroll-container":".chat-message .list"},null,8,["src","preview-src-list","initial-index"])])):F("",!0)])],40,Me)],2)]))),128))])]),_:1}),e("div",Ie,[e("div",ze,[e("ul",null,[t(U,{onSuccess:v,"show-file-list":!1},{default:d(()=>[e("li",null,[t(w,null,{default:d(()=>[t(o(ae))]),_:1})])]),_:1}),e("li",null,[t(w,null,{default:d(()=>[t(o(le))]),_:1})]),e("li",null,[t(w,null,{default:d(()=>[t(o(ce))]),_:1})]),e("li",null,[t(w,null,{default:d(()=>[t(o(ie))]),_:1})])])]),e("div",De,[t(V,{modelValue:n.value,"onUpdate:modelValue":s[0]||(s[0]=r=>n.value=r),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),t(l,{type:"success",onClick:T,disabled:!n.value},{default:d(()=>[me("发送")]),_:1},8,["disabled"])])])])),[[E,(N=o(_))==null?void 0:N.loading]])}}});const je=te(Ee,[["__scopeId","data-v-50781a32"]]),qe={class:"chat-session"},Re={class:"head"},Ye={class:"tools"},Fe={class:"list"},Je=["onClick"],Oe={class:"avatar"},He={class:"det"},Le={class:"name"},Ae={class:"message"},Ke={class:"status"},We={class:"date"},Xe=z({name:"undefined"}),Ge=z({...Xe,setup(g){const{browser:m}=W(),{chat:x}=se(),{session:_,message:p}=H(),{refs:y,setRefs:n}=X();K.useDialog({onFullscreen(){Z(()=>{var v;(v=y.scroller)==null||v.update()})}});const C=$(""),S=R(()=>(_==null?void 0:_.list.filter(v=>{var a;return(a=v.nickName)==null?void 0:a.includes(C.value)}))||[]);async function T(v){m.isMini&&x.expand(!1),_.set(v),await p.get({page:1}),x.scrollToBottom()}return(v,a)=>{var V;const f=u("el-input"),s=u("el-icon"),k=u("cl-avatar"),B=u("el-badge"),D=u("el-empty"),w=u("el-scrollbar"),U=G("loading");return h(),b("div",qe,[e("div",Re,[t(f,{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=l=>C.value=l),placeholder:"关键字搜索",clearable:""},null,8,["modelValue"]),e("ul",Ye,[e("li",null,[t(s,null,{default:d(()=>[t(o(re))]),_:1})]),e("li",{onClick:a[1]||(a[1]=l=>o(_).get())},[t(s,null,{default:d(()=>[t(o(ue))]),_:1})])])]),P((h(),b("div",Fe,[t(w,{class:"scroller",ref:o(n)("scroller")},{default:d(()=>[(h(!0),b(Y,null,Q(S.value,(l,E)=>{var c,i;return h(),b("div",{class:O(["item",{"is-active":l.id==((i=(c=o(_))==null?void 0:c.value)==null?void 0:i.id)}]),key:E,onClick:M=>T(l)},[e("div",Oe,[t(B,{value:l.num,hidden:l.num==0},{default:d(()=>[t(k,{shape:"square",src:l.avatar},null,8,["src"])]),_:2},1032,["value","hidden"])]),e("div",He,[e("p",Le,I(l.nickName),1),e("p",Ae,I(l.text),1)]),e("div",Ke,[e("p",We,I(l.createTime),1)])],10,Je)}),128)),S.value.length==0?(h(),J(D,{key:0,"image-size":100,description:"暂无会话"})):F("",!0)]),_:1},512)])),[[U,(V=o(_))==null?void 0:V.loading]])])}}});const Pe=te(Ge,[["__scopeId","data-v-490e6747"]]),Qe={class:"cl-chat__wrap"},Ze={class:"cl-chat__session"},et={class:"cl-chat__right"},tt={class:"cl-dialog__controls-icon"},st=z({name:"cl-chat"}),Ft=z({...st,setup(g,{expose:m}){const{mitt:x,refs:_,setRefs:p}=X(),{browser:y,onScreenChange:n}=W(),{session:C,message:S}=H(),{user:T}=A();ne.get("chat");const v=$(!1),a=$(!0),f=$(parseInt(String(Math.random()*100)));let s;function k(){E()}function B(){v.value=!0,k()}function D(){v.value=!1}function w(c){a.value=c===void 0?!a.value:c}function U(c,i){i&&V(c)}function V(c){var i,M,N,r;S.list.push({fromId:(i=T.info)==null?void 0:i.id,toId:(M=C.value)==null?void 0:M.userId,avatar:(N=T.info)==null?void 0:N.headImg,nickName:(r=T.info)==null?void 0:r.nickName,createTime:oe().format("YYYY-MM-DD HH:mm:ss"),...c}),l()}const l=ge(()=>{Z(()=>{const c=document.querySelector(".cl-chat .chat-message .list");c==null||c.scroll({top:1e5+Math.random(),behavior:"smooth"})})},300);async function E(){await C.get(),await S.get(),l()}return ve("chat",{get socket(){return s},send:U,append:V,expand:w,scrollToBottom:l}),n(()=>{a.value=!y.isMini}),m({open:B,close:D}),(c,i)=>{const M=u("cl-svg"),N=u("el-badge"),r=u("el-icon"),q=u("cl-dialog");return h(),b("div",Qe,[t(N,{value:f.value},{default:d(()=>[e("div",{class:"cl-chat__icon",onClick:B},[t(M,{name:"icon-notice",size:16})])]),_:1},8,["value"]),t(q,{modelValue:v.value,"onUpdate:modelValue":i[2]||(i[2]=j=>v.value=j),title:"聊天窗口",height:"700px",width:"1200px",padding:"0","keep-alive":"",ref:o(p)("dialog"),"close-on-click-modal":!1,"close-on-press-escape":"",controls:["slot-expand","cl-flex1","fullscreen","close"]},{"slot-expand":d(()=>[e("button",tt,[a.value?(h(),J(r,{key:1,onClick:i[1]||(i[1]=j=>a.value=!1)},{default:d(()=>[t(o(de))]),_:1})):(h(),J(r,{key:0,onClick:i[0]||(i[0]=j=>a.value=!0)},{default:d(()=>[t(o(_e))]),_:1}))])]),default:d(()=>[e("div",{class:O(["cl-chat",{"is-mini":o(y).isMini,"is-expand":a.value}])},[e("div",Ze,[t(Pe)]),e("div",et,[t(je)])],2)]),_:1},8,["modelValue"])])}}});export{Ft as default};
