import{l as de}from"./@vue.runtime-dom-99571815.js";import{u as pe,i as ce,m as me,x as fe,h as Z}from"./index-bb32f0e8.js";import{_ as ge,J as ve}from"./@element-plus.icons-vue-73c86597.js";import{a as be}from"./vuedraggable-b14ef1fe.js";import{p as ee,g as he,a as ae,U as ye}from"./index-056683e9.js";import{u as ke}from"./index-0aca6396.js";import{w as te,v as _e}from"./lodash-es-74a5df03.js";import{a as V}from"./element-plus-ca11a4ea.js";import{j as se,t as v,q as we,X as N,o as d,c as b,a as $,F as oe,b as h,K as c,G as J,N as y,J as x,n as Se,O as Ce,M as xe}from"./@vue.runtime-core-561bebe5.js";import{r as ze,u as k}from"./@vue.reactivity-97074417.js";import{o as le,O as K}from"./@vue.shared-40d3234d.js";import{_ as Be}from"./_plugin-vue_export-helper-c27b6911.js";import"./store-acb3382e.js";import"./chardet-cfd7d38a.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./pinia-d82d1bdc.js";import"./vue-demi-71ba0ef2.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-0ed26588.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-c769f697.js";import"./@vueuse.core-c33523a6.js";import"./@vueuse.shared-b7ebfaaa.js";import"./mitt-b509fb6d.js";import"./mockjs-597bdf6e.js";import"./vue-052dfabe.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./dayjs-e0a79e34.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./sortablejs-fcb1c1b8.js";import"./ts-wps-c1dd0e62.js";const Ue={key:0,class:"cl-upload__demo is-dragger"},Fe={key:1,class:"cl-upload__demo"},Ve={key:0},Ne={class:"cl-upload__item"},$e=se({name:"cl-upload"}),De=se({...$e,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,autoUpload:{type:Boolean,default:!0},size:[String,Number,Array],icon:null,text:String,showFileList:{type:Boolean,default:!0},draggable:Boolean,drag:Boolean,disabled:Boolean,customClass:String,beforeUpload:Function,isSpace:Boolean,prefixPath:{type:String,default:"app"},menu:{type:String,default:"base"},isEdit:null,scope:null,prop:null,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(l,{expose:ie,emit:_}){const o=l;de(e=>({"527bb6e5":X.value[0],"527bb704":X.value[1]}));const{service:D,refs:z,setRefs:O}=ke(),{user:G}=pe(),re=ce.useForm(),{options:A}=me.get("upload"),X=v(()=>{const e=o.size||A.size;return(te(e)?e:[e,e]).map(a=>_e(a)?a+"px":a)}),B=v(()=>o.isDisabled||o.disabled),P=v(()=>B.value||o.isSpace),q=o.limit||A.limit.upload,I=o.limitSize||A.limit.size,L=v(()=>{if(o.text)return o.text;switch(o.type){case"file":return"選擇文件";case"image":return"選擇圖片";default:return""}}),M=v(()=>({Authorization:G.token})),s=ze([]),U=v(()=>o.accept||(o.type=="file"?"":"image/*")),R=v(()=>o.multiple?!B.value&&q-s.value.length>0:s.value.length==0);async function E(e,a){function i(){const t={uid:e.uid,size:e.size,name:e.name,type:ae(e.name),progress:0,url:"",preload:"",error:""};return t.type=="image"&&e instanceof File&&(t.preload=window.webkitURL.createObjectURL(e)),_("upload",t,e),o.autoUpload?(a?Object.assign(a,t):o.multiple?R.value?s.value.push(t):V.warning(`最多隻能上傳${q.value}個文件`):s.value=[t],!0):!1}if(o.beforeUpload){const t=o.beforeUpload(e,a,{next:i});return fe(t)?t.then(i).catch(()=>null):t&&i(),t}else return e.size/1024/1024>=I?(V.error(`上傳文件大小不能超過 ${I}MB!`),!1):i()}function H(e){s.value.splice(e,1),F()}function Q(){s.value=[]}async function T(e,a){if(a||(a=s.value.find(t=>t.uid==e.file.uid)),!a)return!1;const i=Z("");try{const{mode:t,type:w}=await D.base.comm.uploadMode(),m=t=="local",n=i+"_"+e.file.name,f=m?n:ee(o.prefixPath,o.menu,n);return new Promise((g,W)=>{async function S({host:r,preview:ne,data:Y}){const C=new FormData;C.append("key",f);for(const u in Y)C.has(u)||C.append(u,Y[u]);C.append("file",e.file),await D.request({url:r,method:"POST",headers:{"Content-Type":"multipart/form-data",Authorization:m?G.token:null},timeout:6e5,data:C,onUploadProgress(u){a.progress=u.total?Math.floor(u.loaded/u.total*100):0,_("progress",a)},proxy:m,NProgress:!1}).then(u=>{m?a.url=u:a.url=ee(ne||r,f),a.fileId=i,a.key=f,_("success",a),g(a.url),F()}).catch(u=>{V.error(u.message),a.error=u.message,_("error",a),W(u)})}m?S({host:"/admin/base/comm/upload"}):D.base.comm.upload(w=="aws"?{key:f}:{}).then(r=>{switch(w){case"cos":S({host:r.url,data:r.credentials});break;case"oss":S({host:r.host,data:{OSSAccessKeyId:r.OSSAccessKeyId,policy:r.policy,signature:r.signature}});break;case"qiniu":S({host:r.uploadUrl,preview:r.publicDomain,data:{token:r.token}});break;case"aws":S({host:r.url,data:r.fields});break}}).catch(W)})}catch{V.error("上傳配置錯誤")}}function j(){return s.value.find(e=>!e.url)}function F(){j()||(_("update:modelValue",he(s.value)),Se(()=>{var e;o.prop&&((e=re.value)==null||e.validateField(o.prop))}))}function ue(e){var a,i,t;Q(),(a=z.upload)==null||a.clearFiles(),(i=z.upload)==null||i.handleStart(e),(t=z.upload)==null||t.submit()}const p={data:void 0,open(e){var a;p.data=e,(a=z.space)==null||a.open({limit:e||!o.multiple?1:q})},onConfirm(e){p.data?(Object.assign(p.data,e[0]),p.data=void 0):s.value.push(...e),F()}};return we(()=>o.modelValue,e=>{if(j())return!1;const a=(te(e)?e:[e]).filter(Boolean);s.value=a.map((i,t)=>Object.assign({type:ae(i),progress:100,uid:Z(),url:i},s.value[t])).filter((i,t)=>o.multiple?!0:t==0)},{immediate:!0}),ie({isAdd:R,list:s,check:j,clear:Q,remove:H,upload:ue}),(e,a)=>{const i=N("el-button"),t=N("el-upload"),w=N("el-icon"),m=N("cl-upload-space");return d(),b(oe,null,[$("div",{class:le(["cl-upload__wrap",[l.customClass]])},[$("div",{class:le(["cl-upload",[`cl-upload--${l.type}`,{"is-disabled":B.value,"is-drag":l.drag}]])},[l.drag?y("",!0):(d(),b(oe,{key:0},[l.type=="file"?(d(),b("div",{key:0,class:"cl-upload__file-btn",onClick:a[0]||(a[0]=n=>p.open())},[h(t,{ref:k(O)("upload"),drag:l.drag,action:"",accept:U.value,"show-file-list":!1,"before-upload":E,"http-request":T,headers:M.value,multiple:l.multiple,disabled:P.value},{default:c(()=>[J(e.$slots,"default",{},()=>[h(i,{type:"success"},{default:c(()=>[Ce(K(L.value),1)]),_:1})],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):y("",!0)],64)),l.showFileList?(d(),x(k(be),{key:1,class:"cl-upload__list",tag:"div",modelValue:s.value,"onUpdate:modelValue":a[2]||(a[2]=n=>s.value=n),"ghost-class":"Ghost","drag-class":"Drag",options:{group:"Upload",animation:300,draggable:".is-drag",disabled:!l.draggable},"item-key":"uid",onEnd:F},{footer:c(()=>[(l.type=="image"||l.drag)&&R.value?(d(),b("div",{key:0,class:"cl-upload__footer",onClick:a[1]||(a[1]=n=>p.open())},[h(t,{action:"",drag:l.drag,ref:k(O)("upload"),accept:U.value,"show-file-list":!1,"before-upload":E,"http-request":T,headers:M.value,multiple:l.multiple,disabled:P.value},{default:c(()=>[J(e.$slots,"default",{},()=>[l.drag?(d(),b("div",Ue,[h(w,{size:46},{default:c(()=>[h(k(ge))]),_:1}),$("div",null," 點擊上傳或將文件拖動到此處，文件大小限制"+K(k(I))+"M ",1)])):(d(),b("div",Fe,[h(w,{size:36},{default:c(()=>[l.icon?(d(),x(xe(l.icon),{key:0})):(d(),x(k(ve),{key:1}))]),_:1}),L.value?(d(),b("span",Ve,K(L.value),1)):y("",!0)]))],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):y("",!0)]),item:c(({element:n,index:f})=>[l.showFileList?(d(),x(t,{key:0,class:"is-drag",action:"",accept:U.value,"show-file-list":!1,"http-request":g=>T(g,n),"before-upload":g=>{E(g,n)},headers:M.value,disabled:P.value,onClick:g=>p.open(n)},{default:c(()=>[J(e.$slots,"item",{item:n,index:f},()=>[$("div",Ne,[h(ye,{item:n,list:s.value,disabled:B.value,onRemove:g=>H(f)},null,8,["item","list","disabled","onRemove"])])],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled","onClick"])):y("",!0)]),_:3},8,["modelValue","options"])):y("",!0)],2)],2),l.isSpace?(d(),x(m,{key:0,ref:k(O)("space"),"show-btn":!1,accept:U.value,onConfirm:p.onConfirm},null,8,["accept","onConfirm"])):y("",!0)],64)}}});const wa=Be(De,[["__scopeId","data-v-872714af"]]);export{wa as default};
