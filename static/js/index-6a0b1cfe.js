import{i as U,d as P,m as Q,b as B,c as Y,e as Z}from"./index-bb32f0e8.js";import{R as ee,S as te,o as oe,d as ne}from"./@element-plus.icons-vue-73c86597.js";import{d as le}from"./dayjs-e0a79e34.js";import"./store-acb3382e.js";import{u as R}from"./index-0aca6396.js";import{x as q,q as re}from"./lodash-es-74a5df03.js";import{a as V}from"./element-plus-ca11a4ea.js";import{j as g,X as n,o as c,c as k,b as r,K as s,O as $,F as E,t as ae,d as se,J as C,N as D,V as L,$ as pe,L as ie}from"./@vue.runtime-core-561bebe5.js";import{u as F,r as ce}from"./@vue.reactivity-97074417.js";import{u as ue}from"./menu-882dd0f5.js";import"./socket.io-client-c7af6a83.js";import{O as M}from"./@vue.shared-40d3234d.js";import{_ as me}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vue.runtime-dom-99571815.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-d82d1bdc.js";import"./vue-demi-71ba0ef2.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-0ed26588.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-c769f697.js";import"./@vueuse.core-c33523a6.js";import"./@vueuse.shared-b7ebfaaa.js";import"./mitt-b509fb6d.js";import"./mockjs-597bdf6e.js";import"./vue-052dfabe.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./engine.io-client-0a8b97a6.js";import"./engine.io-parser-b13552ae.js";import"./@socket.io.component-emitter-3e1df240.js";import"./socket.io-parser-bc267b40.js";const de=g({name:"undefined"}),_e=g({...de,props:{data:{type:Array,default:()=>[]}},setup(I){const f=I,{service:x,refs:y,setRefs:_}=R(),b=U.useForm();function v(){var u;(u=b.value)==null||u.open({title:"導出",width:"600px",props:{labelPosition:"top"},items:[{label:"選擇菜單",prop:"ids",component:{name:"el-tree-select",ref:_("ids"),props:{data:f.data,nodeKey:"id",multiple:!0,showCheckbox:!0,collapseTags:!0,collapseTagsTooltip:!0,props:{label:"name"}}}}],on:{submit(m,{done:o,close:l}){const e=[...y.ids.getCheckedKeys(),...y.ids.getHalfCheckedKeys()];q(e)?(V.warning("請先選擇要導出的菜單"),o()):x.base.sys.menu.export({ids:e}).then(t=>{l();const i=new Blob([JSON.stringify(t)],{type:"application/json"}),p=URL.createObjectURL(i),d=document.createElement("a");d.href=p,d.download=`菜單數據 ${le().format("MM-DD HH_mm_ss")}.json`,d.click(),URL.revokeObjectURL(p)}).catch(t=>{V.error(t.message)})}}})}return(u,m)=>{const o=n("el-button"),l=n("cl-form");return c(),k(E,null,[r(o,{type:"info",icon:F(ee),onClick:v},{default:s(()=>[$("導出")]),_:1},8,["icon"]),r(l,{ref_key:"Form",ref:b},null,512)],64)}}}),fe=g({name:"undefined"}),be=g({...fe,setup(I){const{service:f}=R(),x=U.useForm(),y=U.useCrud(),_=ce(!1);function b(v,u){_.value=!0;const m=new FileReader;m.onload=o=>{var l,e;_.value=!1;try{const t=JSON.parse((l=o.target)==null?void 0:l.result);(e=x.value)==null||e.open({title:"菜單導入",height:"400px",width:"600px",props:{labelWidth:"0px"},op:{saveButtonText:"添加"},items:[{component:{name:"slot-tips"}},{component:{name:"el-tree",props:{data:re(t,"orderNum","asc"),nodeKey:"name",props:{label:"name",children:"childMenus"},renderContent(i,{data:p}){return p.name}},style:{padding:"5px",borderRadius:"var(--el-border-radius-base)",border:"1px solid var(--el-border-color)"}}}],on:{submit(i,{close:p,done:d}){f.base.sys.menu.import({menus:t}).then(()=>{var h;V.success("導入成功"),(h=y.value)==null||h.refresh(),p()}).catch(h=>{V.error(h.message),d()})}}})}catch(t){V.error(`${u.name}文件格式錯誤：${t}`)}},m.readAsText(u)}return(v,u)=>{const m=n("el-button"),o=n("cl-upload"),l=n("el-alert"),e=n("cl-form");return c(),k(E,null,[r(o,{type:"file","show-file-list":!1,"auto-upload":!1,disabled:_.value,onUpload:b},{default:s(()=>[r(m,{type:"success",icon:F(te),loading:_.value},{default:s(()=>[$("導入")]),_:1},8,["icon","loading"])]),_:1},8,["disabled"]),r(e,{ref_key:"Form",ref:x},{"slot-tips":s(()=>[r(l,{type:"warning"},{default:s(()=>[$("如遇到問題無法導入菜單，請檢查文件並嘗試重新導入。")]),_:1})]),_:1},512)],64)}}}),he=g({name:"menu-create"}),ye=g({...he,setup(I){const{service:f,mitt:x}=R(),y=ue(),_=U.useForm(),b=[],v=ae(()=>P(b.map(o=>o.value)));function u(){var o;(o=_.value)==null||o.open({title:"快速創建",width:"800px",items:[{prop:"module",label:"選擇模塊",span:10,component:{name:"cl-select",props:{filterable:!0,clearable:!0,placeholder:"請選擇模塊",allowCreate:!0,defaultFirstOption:!0,options:Q.dirs}},required:!0},{prop:"entity",label:"數據結構",span:14,component:{name:"slot-entity"},required:!0},{prop:"name",label:"菜單名稱",span:10,component:{name:"el-input",props:{placeholder:"請輸入菜單名稱"}},required:!0},{prop:"router",label:"菜單路由",span:14,component:{name:"el-input",props:{placeholder:"請輸入菜單路由，如：/test"}}},{prop:"parentId",label:"上級節點",component:{name:"cl-menu-select",props:{type:1}}},{prop:"keepAlive",value:!0,label:"路由緩存",component:{name:"el-radio-group",options:[{label:"開啟",value:!0},{label:"關閉",value:!1}]}},{prop:"icon",label:"菜單圖標",component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序號",component:{name:"el-input-number",props:{placeholder:"請填寫排序號",min:0,max:99,"controls-position":"right"}}},{prop:"isCreateFile",label:"是否創建文件",value:1,component:{name:"el-radio-group",options:[{label:"是",value:1},{label:"否",value:0}]}}],on:{submit(l,{done:e,close:t}){const{api:i,prefix:p,columns:d}=b.find(h=>h.value==l.entity.join("/"));y.create({...l,router:l.router,module:l.module,prefix:p,api:i,columns:d}).then(h=>{l.isCreateFile&&h(),x.emit("magic.createMenu"),t()}).catch(h=>{e()})}}})}function m(o){var e;const l=b.find(t=>t.value==o.join("/"));l&&((e=_.value)==null||e.setForm("router",`/${l.value}`))}return se(()=>{f.base.open.eps().then(o=>{for(const l in o)o[l].forEach(e=>{q(e.columns)||b.push({value:e.prefix.substring(7),...e})})})}),(o,l)=>{const e=n("el-button"),t=n("el-cascader"),i=n("cl-form");return c(),k(E,null,[r(e,{type:"success",onClick:u},{default:s(()=>[$("快速創建")]),_:1}),r(i,{ref_key:"Form",ref:_},{"slot-entity":s(({scope:p})=>[r(t,{modelValue:p.entity,"onUpdate:modelValue":d=>p.entity=d,filterable:"",separator:".",options:v.value,onChange:m},null,8,["modelValue","onUpdate:modelValue","options"])]),_:1},512)],64)}}}),ve=g({name:"auto-menu"}),ge=g({...ve,setup(I){return(f,x)=>F(B)?(c(),C(ye,{key:0})):D("",!0)}}),xe=g({name:"auto-perms"}),ke=g({...xe,props:{menuId:[String,Number]},emits:["open","close"],setup(I,{emit:f}){const x=I,{service:y}=R(),_=U.useForm();async function b(){return y.base.open.eps().then(u=>{const m=[],o=[];for(const l in u)u[l].forEach(e=>{var t;e.prefix=(t=e.prefix)==null?void 0:t.replace("/admin/",""),e.prefix&&o.push(e.prefix),m.push(e)});return{prop:"entity",label:"实体数据",component:{name:"el-cascader",props:{options:P(o),separator:".",props:{multiple:!0},onChange(l){var t;const e=[];l.forEach(i=>{const p=m.find(d=>d.prefix==i.join("/"));p&&(p.api.forEach(d=>{d.perms=(p.prefix+d.path).replace(/\//g,":"),d.checked=!0}),e.push(p))}),(t=_.value)==null||t.setForm("list",e)}}}}})}async function v(){var u;f("open"),(u=_.value)==null||u.open({title:"自动添加权限",width:"800px",dialog:{draggable:!0,controls:["close"]},props:{labelPosition:"top"},op:{saveButtonText:"一键添加"},items:[await b(),{prop:"list",label:"权限列表",value:[],hidden({scope:m}){return!m.entity},component:{name:"slot-list"}}],on:{submit(m,{done:o,close:l}){if(!m.entity){V.error("请选择实体数据"),o();return}const e=m.list.map(t=>t.api).flat().filter(t=>t.checked);if(e.find(t=>!t.summary)){V.error("請填寫权限名称"),o();return}if(e.length==0){V.error("请至少选择一个权限"),o();return}Promise.all(e.map(t=>y.base.sys.menu.add({type:2,parentId:x.menuId,name:t.summary,perms:t.perms}))).then(()=>{V.success("添加权限成功"),l(),f("close")}).catch(t=>{o(),V.error(t.message)})}}})}return(u,m)=>{const o=n("el-button"),l=n("el-divider"),e=n("el-switch"),t=n("el-input"),i=n("cl-menu-perms"),p=n("el-scrollbar"),d=n("cl-form");return c(),k(E,null,[F(B)?(c(),C(o,{key:0,onClick:v,style:{"margin-left":"10px"}},{default:s(()=>[$("自动添加")]),_:1})):D("",!0),r(d,{ref_key:"Form",ref:_},{"slot-list":s(({scope:h})=>[r(p,{class:"scrollbar"},{default:s(()=>[(c(!0),k(E,null,L(h.list,(N,O)=>(c(),k("div",{class:"list",key:O},[r(l,{"content-position":"left"},{default:s(()=>[$(M(N.prefix),1)]),_:2},1024),(c(!0),k(E,null,L(N.api,(w,S)=>(c(),k("div",{class:"item",key:S},[r(e,{modelValue:w.checked,"onUpdate:modelValue":A=>w.checked=A},null,8,["modelValue","onUpdate:modelValue"]),r(t,{modelValue:w.summary,"onUpdate:modelValue":A=>w.summary=A,clearable:"",placeholder:"权限名称",disabled:!w.checked},null,8,["modelValue","onUpdate:modelValue","disabled"]),r(i,{modelValue:w.perms,"onUpdate:modelValue":A=>w.perms=A,disabled:!w.checked},null,8,["modelValue","onUpdate:modelValue","disabled"])]))),128))]))),128))]),_:2},1024)]),_:1},512)],64)}}});const we=me(ke,[["__scopeId","data-v-eb15bd38"]]),Ve={key:1},Ce={key:1},Fe=g({name:"sys-menu"}),ht=g({...Fe,setup(I){const{service:f,mitt:x}=R(),{menu:y}=Y(),_=U.useTable({contextMenu:[e=>({label:"新增",hidden:!(e.type!=2&&f.base.sys.user._permission.add),callback(t){o(e),t()}}),"update","delete",e=>({label:"权限",hidden:!(e.type!=2&&f.base.sys.user._permission.add),callback(t){l(e),t()}})],columns:[{type:"selection"},{prop:"name",label:"名称",align:"left",width:200,fixed:"left"},{prop:"isShow",label:"是否显示",width:100,component:{name:"cl-switch",props:{activeValue:!0,inactiveValue:!1,onChange(){y.get()}}}},{prop:"icon",label:"图标",width:100},{prop:"type",label:"类型",width:100,dict:[{label:"目录",value:0,type:"warning"},{label:"菜单",value:1,type:"success"},{label:"权限",value:2,type:"danger"}]},{prop:"router",label:"节点路由",minWidth:160},{prop:"keepAlive",label:"路由缓存",width:100},{prop:"viewPath",label:"文件路径",minWidth:200,showOverflowTooltip:!0},{prop:"perms",label:"权限",headerAlign:"center",minWidth:300},{prop:"orderNum",label:"排序号",width:90,fixed:"right"},{prop:"updateTime",label:"更新時間",sortable:"custom",width:160},{label:"操作",type:"op",width:250,buttons:["slot-add","edit","delete"]}]}),b=U.useUpsert({dialog:{width:"800px"},items:[{prop:"type",value:0,label:"节点类型",required:!0,component:{name:"el-radio-group",options:[{label:"目录",value:0},{label:"菜单",value:1},{label:"权限",value:2}]}},{prop:"name",label:"节点名称",component:{name:"el-input"},required:!0},{prop:"parentId",label:"上级节点",hook:"empty",component:{name:"slot-parentId"}},{prop:"router",label:"节点路由",hidden:({scope:e})=>e.type!=1,component:{name:"el-input",props:{placeholder:"请输入节点路由，如：/test"}}},{prop:"keepAlive",value:!0,label:"路由缓存",hidden:({scope:e})=>e.type!=1,component:{name:"el-radio-group",options:[{label:"开启",value:!0},{label:"关闭",value:!1}]}},{prop:"isShow",label:"是否显示",value:!0,hidden:({scope:e})=>e.type==2,flex:!1,component:{name:"el-switch"}},{prop:"viewPath",label:"文件路径",hidden:({scope:e})=>e.type!=1,component:{name:"cl-menu-file"}},{prop:"icon",label:"节点图标",hidden:({scope:e})=>e.type==2,component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序号",component:{name:"el-input-number",props:{placeholder:"請填寫排序号",min:0,max:99,"controls-position":"right"}}},{prop:"perms",label:"权限",hidden:({scope:e})=>e.type!=2,component:{name:"slot-perms"}}],plugins:[U.setFocus("name")]}),v=U.useCrud({service:f.base.sys.menu,onRefresh(e,{render:t}){f.base.sys.menu.list().then(i=>{i.map(p=>{p.permList=p.perms?p.perms.split(","):[]}),t(Z(i)),y.get()})}},e=>{e.refresh()});function u(e){var t;(t=v.value)==null||t.refresh(e)}function m(e,t){var i;t!=null&&t.property&&e.children&&((i=_.value)==null||i.toggleRowExpansion(e))}function o({type:e,id:t}){var i;(i=v.value)==null||i.rowAppend({parentId:t,parentType:e,type:e+1,keepAlive:!0,isShow:!0})}function l({id:e}){var t;(t=v.value)==null||t.rowAppend({parentId:e,type:2})}return x.on("magic.createMenu",u),(e,t)=>{const i=n("cl-refresh-btn"),p=n("cl-add-btn"),d=n("cl-multi-delete-btn"),h=n("cl-flex1"),N=n("cl-row"),O=n("cl-svg"),w=n("el-tag"),S=n("el-link"),A=n("el-icon"),K=n("el-button"),W=n("cl-table"),H=n("cl-menu-select"),J=n("cl-menu-perms"),z=n("cl-upsert"),X=n("cl-crud"),G=pe("permission");return c(),C(X,{ref_key:"Crud",ref:v},{default:s(()=>[r(N,null,{default:s(()=>{var a;return[r(i),r(p),r(d),r(ge),r(h),r(be),r(_e,{data:(a=F(_))==null?void 0:a.data},null,8,["data"])]}),_:1}),r(N,null,{default:s(()=>[r(W,{ref_key:"Table",ref:_,"row-key":"id",onRowClick:m},{"column-icon":s(({scope:a})=>[r(O,{name:a.row.icon,size:"16px",style:{"margin-top":"5px"}},null,8,["name"])]),"column-perms":s(({scope:a})=>[(c(!0),k(E,null,L(a.row.permList,(T,j)=>(c(),C(w,{key:j,effect:"plain",size:"small",style:{margin:"2px","letter-spacing":"0.5px"}},{default:s(()=>[$(M(T),1)]),_:2},1024))),128))]),"column-router":s(({scope:a})=>[a.row.type==1?(c(),C(S,{key:0,type:"success",href:a.row.router},{default:s(()=>[$(M(a.row.router),1)]),_:2},1032,["href"])):(c(),k("span",Ve,M(a.row.router),1))]),"column-keepAlive":s(({scope:a})=>[a.row.type==1?(c(),C(A,{key:0},{default:s(()=>[a.row.keepAlive?(c(),C(F(oe),{key:0})):(c(),C(F(ne),{key:1}))]),_:2},1024)):(c(),k("span",Ce))]),"slot-add":s(({scope:a})=>[ie((c(),C(K,{type:"success",text:"",bg:"",onClick:T=>o(a.row)},{default:s(()=>[$("新增")]),_:2},1032,["onClick"])),[[G,{and:[F(f).base.sys.menu.permission.add,a.row.type!=2]}]])]),_:1},512)]),_:1}),r(z,{ref_key:"Upsert",ref:b},{"slot-parentId":s(({scope:a})=>[r(H,{modelValue:a.parentId,"onUpdate:modelValue":T=>a.parentId=T,type:a.type},null,8,["modelValue","onUpdate:modelValue","type"])]),"slot-perms":s(({scope:a})=>[r(J,{modelValue:a.perms,"onUpdate:modelValue":T=>a.perms=T},null,8,["modelValue","onUpdate:modelValue"]),r(we,{"menu-id":a.parentId,onOpen:t[0]||(t[0]=T=>{var j;return(j=F(b))==null?void 0:j.close()}),onClose:t[1]||(t[1]=T=>u())},null,8,["menu-id"])]),_:1},512)]),_:1},512)}}});export{ht as default};
