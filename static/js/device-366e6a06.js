import{u as $,i as ee}from"./index-c3533fa0.js";import{a as te}from"./@vueuse.core-c33523a6.js";import{m as oe}from"./mqtt-ec323294.js";import"./store-acb3382e.js";import{u as L}from"./index-292cfcf2.js";import{d as se}from"./dayjs-e0a79e34.js";import{o as ne}from"./vue-router-c769f697.js";import{q as ae,d as ie}from"./lodash-es-74a5df03.js";import{a as X}from"./element-plus-ca11a4ea.js";import{j as Z,t as re,n as S,am as ce,X as u,$ as le,o as A,J as ue,K as C,a as s,b as p,L as pe,c as w,F as me,V as de,N as ve,O as _e}from"./@vue.runtime-core-561bebe5.js";import{u as Ae}from"./hook-37ea9ef9.js";import{r as E,u as m}from"./@vue.reactivity-97074417.js";import{O as f,o as M}from"./@vue.shared-40d3234d.js";import{_ as fe}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vue.runtime-dom-99571815.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-d82d1bdc.js";import"./vue-demi-71ba0ef2.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-0ed26588.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./mitt-b509fb6d.js";import"./mockjs-597bdf6e.js";import"./vue-052dfabe.js";import"./@element-plus.icons-vue-73c86597.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./@vueuse.shared-b7ebfaaa.js";let t;function ge(){const{mitt:D}=L();function d(a,r){t==null||t.publish(a,r)}function v(a){t==null||t.subscribe(`${a}@admin`,function(r){})}function b(){_(),t=oe.connect("ws://127.0.0.1:8083"),t&&(t.on("connect",function(){}),t.on("message",function(a,r){D.emit("iot.message",{id:a.split("@")[0],message:r.toString()})}),t.on("error",function(a){t==null||t.reconnect()}))}function _(){t==null||t.end()}return{client:t,connect:b,disconnect:_,subscribe:v,send:d}}const j="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAA19JREFUeF7tmcvrTVEUxz/fEv4Bj5RkQEoZCBlIpDxiQt7JQPL6JY/ERHnEQJgoZCDJM68oykD8zA1MUDKRCZmZyWBp6dw6jnPvPWdf19m6ew3vWfusvT77u9Y+d28x4KYBz58EIClgwAmkEhhwAaQmmEoglcCAE0glMOAC6G0XMLNLwAJgakMg3wPDkraHxg8uATOz0KD9GCcpKJegQWZ2FDjSj0R6eOcxST6vWhYK4Bawvlak/jvflrShbphQAC+y2q8br5P/XeAecAKYEvBi7wUL646LCcBCScNmNhpwKR+qmUx0ALYBK4FlFRK5IGko72dmc4FjwOIK490lKgBPJK3wWZnZKmAXsKhNIl+9nCS9LXtuZjuA48CYLiCiArBM0tPCinrT3AnMLyTStXub2TRgL9Bpv48GwCVJvmqlZmabMxAu8TeA176r4JeZ2ThJX9qowSHuA+aUPI8CgE98nqQP3erWzLYCIyVdyCU/CngIPJN0tg2E8cAe4AAwIucTBYDDkk4WpL9J0vVuQLLVPwicynxfA2ck3WgDYilwFRibPW8cwCtJswvJ+07g/xduu3Qlfe5QGrOAR8CEgo/3ktOSnhfefQ7YHZMCVku6n5PzJOAJMD377RuwX9LlNit6DdjUQSlXMhDvzGwJ8FuTbXobvCNpXWGFvIb3lyT0IAPxMQdrC1AKpjD+h5cFMBNwCHlrtAS8kZ1v7eXZCj0uNKn8ZL9nJXHRzCZnjW9GlT7RwadRAD4v38r8i+6omXnyyysk5CXiO4Z39V6tcQCtBHxvb9V9r0nVGR8NgDqT/pu+CcD//ne4VzX8UwX4QWh05ucJdScVdCBSN0jM/kEAzGywFWBm/TgT7FUo/7QHJAB9OBVOCuiRQKMl4NvPy4oJVLlSK97w+Olwy1rjvRHnm3GzAEK+wsqAZTuM95i8/XFwWtKIE4CQRQj9DijuAkH0kwJKCPy3JVCxAVZ1K35ptvvGb6wJ+hGY3/LEZBcl+RVcLQvtAR7ofK1I/Xceyl+yVA0XBMBfbmZ3gDVVA/XZ766ktSExggFkEDYCfkMzMST4Xxjzye8HJN0MfVdPAEKDxjQuAYhpNZqYS1JAE9RjipkUENNqNDGXpIAmqMcUMykgptVoYi5JAU1QjynmT+PCelBN7E0UAAAAAElFTkSuQmCC",he={class:"icon"},Ce={class:"det"},we={class:"name"},be={class:"text"},ye={class:"message"},xe={class:"icon"},Ve=["onContextmenu"],ke={class:"content"},Be={class:"is-text"},Ee={class:"date"},Me={key:0,class:"empty"},De={class:"footer"},Je={class:"input"},Re=Z({name:"iot-device"}),qe=Z({...Re,setup(D){const{service:d,refs:v,setRefs:b,mitt:_}=L(),{copy:a}=te(),{user:r}=$(),y=ge(),{ViewGroup:x}=Ae({label:"设备",title:"消息列表",service:d.iot.device,onEdit(e){return{width:"600px",items:[{label:"设备名称",prop:"name",component:{name:"el-input",props:{maxlength:20,clearable:!0}},required:!0},{label:"设备ID",prop:"uniqueId",component:{name:"el-input",props:{maxlength:30,clearable:!0,disabled:!!(e!=null&&e.id)}},required:!0},{label:"设备图标",prop:"icon",component:{name:"cl-upload"}}]}},async onSelect(e){y.subscribe(e.uniqueId),await q({page:1,deviceId:e.id}),T()}}),V=E(!1),c=E(""),l=E([]),J=re(()=>{var e,o;return(o=(e=x.value)==null?void 0:e.selected)==null?void 0:o.uniqueId}),g={page:1,size:20};let R=!1;async function q(e){V.value=!0,Object.assign(g,{order:"createTime",sort:"desc",...e}),await d.iot.message.page(g).then(o=>{const i=ae(o.list,"createTime");if(g.page==1)l.value=i;else{const h=v.scrollbar.wrapRef.querySelector("ul"),k=h.clientHeight;l.value.unshift(...i),S(()=>{v.scrollbar.scrollTo(0,h.clientHeight-k)})}R=o.pagination.total<=l.value.length}).catch(o=>{X.error(o.message)}),V.value=!1}const T=ie(()=>{S(()=>{var e,o;(o=(e=v.scrollbar)==null?void 0:e.wrapRef)==null||o.scroll({top:1e5+Math.random(),behavior:"smooth"})})});function Y({scrollTop:e}){e==0&&!R&&q({page:g.page+1})}function z(){d.iot.mqtt.publish({uniqueId:J.value,data:c.value}).then(()=>{I({data:c.value,type:0}),c.value=""})}function I(e){l.value.push({createTime:new Date,...e}),T()}function P(e,o){ee.ContextMenu.open(e,{hover:{target:"content"},list:[{label:"复制",callback(i){a(o.data||""),X.success("复制成功"),i()}}]})}function G({id:e,message:o}){J.value==e&&I({type:1,data:o})}return ce(()=>{y.connect(),_.on("iot.message",G)}),ne(()=>{y.disconnect(),_.off("iot.message")}),(e,o)=>{const i=u("cl-avatar"),h=u("el-empty"),k=u("el-scrollbar"),F=u("el-input"),U=u("el-button"),H=u("cl-view-group"),O=le("loading");return A(),ue(H,{ref_key:"ViewGroup",ref:x},{item:C(({item:n,selected:B})=>[s("div",{class:M(["device-item",{"is-active":B.id==n.id}])},[s("div",he,[p(i,{shape:"square",src:n.icon||m(j)},null,8,["src"])]),s("div",Ce,[s("p",we,f(n.name),1),s("p",be,f(n.uniqueId),1)]),s("div",{class:M(["status",{"is-on":n.status}])},f(n.status?"在线":"离线"),3)],2)]),right:C(()=>[pe((A(),w("div",ye,[p(k,{class:"list",ref:m(b)("scrollbar"),onScroll:Y},{default:C(()=>[s("ul",null,[(A(!0),w(me,null,de(l.value,(n,B)=>{var K,N,Q;return A(),w("li",{key:B},[s("div",{class:M(["item",{"is-right":n.type==0}])},[s("div",xe,[p(i,{size:36,shape:"square",src:n.type==0?(K=m(r).info)==null?void 0:K.headImg:((Q=(N=m(x))==null?void 0:N.selected)==null?void 0:Q.icon)||m(j)},null,8,["src"])]),s("div",{class:"det",onContextmenu:W=>{P(W,n)}},[s("div",ke,[s("span",Be,f(n.data),1)]),s("div",Ee,f(m(se)(n.createTime).format("YYYY-MM-DD HH:mm:ss")),1)],40,Ve)],2)])}),128))]),l.value.length==0?(A(),w("div",Me,[p(h,{"image-size":100,description:"暂无消息"})])):ve("",!0)]),_:1},512),s("div",De,[s("div",Je,[p(F,{modelValue:c.value,"onUpdate:modelValue":o[0]||(o[0]=n=>c.value=n),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),p(U,{type:"success",onClick:z,disabled:!c.value},{default:C(()=>[_e("发送")]),_:1},8,["disabled"])])])])),[[O,V.value]])]),_:1},512)}}});const Ct=fe(qe,[["__scopeId","data-v-1274675d"]]);export{Ct as default};
